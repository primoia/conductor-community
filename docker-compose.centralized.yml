version: '3.8'
services:
  community-conductor-api:
    build:
      context: ./conductor/conductor
      dockerfile: Dockerfile
    container_name: community-conductor-api
    restart: unless-stopped
    environment:
    - MONGO_INITDB_ROOT_USERNAME=admin
    - MONGO_INITDB_ROOT_PASSWORD=conductor123
    - MONGO_INITDB_DATABASE=conductor
    env_file:
    - ./config/conductor/.env
    volumes:
    - ./config/conductor/config.yaml:/app/config.yaml:ro
    - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
    - 12199:8000
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
    extra_hosts:
    - primoia-mongodb:host-gateway
  community-conductor-bff:
    build:
      context: ./conductor/conductor-gateway
      dockerfile: Dockerfile
    container_name: community-conductor-bff
    restart: unless-stopped
    environment:
    - CONDUCTOR_API_URL=http://community-conductor-api:8000
    env_file:
    - ./config/gateway/.env
    volumes:
    - ./config/gateway/config.yaml:/app/config.yaml:ro
    ports:
    - 14199:8080
    depends_on:
    - community-conductor-api
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
  community-conductor-mcp:
    build:
      context: ../shared/primoia-mcp-sidecar
      dockerfile: Dockerfile
    container_name: community-conductor-mcp
    restart: unless-stopped
    ports:
    - 13199:9000
    environment:
    - TARGET_URL=http://community-conductor-api:8000
    - MCP_PORT=9000
    - MCP_NAME=conductor-mcp
    - MCP_HOST_PORT=13199
    - ENABLE_IAM=true
    - IAM_URL=http://infrastructure-iam-api:8000
    - IAM_API_PREFIX=/api/v1
    - MCP_REGISTRY_ENABLED=${MCP_REGISTRY_ENABLED:-true}
    - MCP_REGISTRY_URL=${MCP_REGISTRY_URL:-http://community-conductor-bff:8080}
    - RATE_LIMIT_MAX_REQUESTS=300
    - RATE_LIMIT_WINDOW=60
    depends_on:
    - community-conductor-api
    - community-conductor-bff
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
  community-conductor-web:
    build:
      context: ./conductor/conductor-web
      dockerfile: Dockerfile.angular
    container_name: community-conductor-web
    restart: unless-stopped
    volumes:
    - ./config/web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
    - 11299:80
    depends_on:
    - community-conductor-bff
    networks:
    - primoia-network

  # Conductor Chat - primobot-core (moltbot fork)
  community-primobot-core:
    build:
      context: ./conductor-chat/primobot-core
      dockerfile: Dockerfile
    container_name: community-primobot-core
    restart: unless-stopped
    ports:
    - 18789:18789
    - 18790:18790
    environment:
    - NODE_ENV=production
    - HOME=/home/node
    - TERM=xterm-256color
    volumes:
    - primobot-config:/home/node/.clawdbot
    - primobot-workspace:/home/node/workspace
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net

  # Conductor Chat - primobot-mcp (REST API adapter)
  community-primobot-mcp:
    build:
      context: ./conductor-chat/primobot-mcp
      dockerfile: Dockerfile
    container_name: community-primobot-mcp
    restart: unless-stopped
    ports:
    - 15199:3100
    - 15299:3101
    environment:
    - NODE_ENV=production
    - PRIMOBOT_CORE_URL=http://community-primobot-core:18789
    - LOG_LEVEL=info
    depends_on:
      community-primobot-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net

volumes:
  primobot-config:
  primobot-workspace:

networks:
  primoia-network:
    driver: bridge
  primoia-shared-infrastructure_primoia-infra-net:
    external: true
