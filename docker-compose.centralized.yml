version: '3.8'
services:
  community-conductor-api:
    build:
      context: ./conductor/conductor
      dockerfile: Dockerfile
    container_name: community-conductor-api
    restart: unless-stopped
    environment:
    - MONGO_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
    - MONGODB_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
    - IAM_ENABLED=true
    - IAM_SECRET_KEY=${PRIMOIA_IAM_SECRET_KEY}
    - IAM_URL=http://infrastructure-iam-api:8000
    - IAM_API_PREFIX=/api/v1
    - CONSTRUCTION_API_URL=http://verticals-construction-api-projects:8001
    - CONDUCTOR_API_URL=http://localhost:8000
    - AMQP_URL=${PRIMOIA_AMQP_URL:-amqp://admin:PrimoiaSecure2025!RabbitMQ@primoia-shared-rabbitmq:5672/}
    - PULSE_ESCALATION_PROJECT_ID=${PULSE_ESCALATION_PROJECT_ID:-2}
    - CONDUCTOR_HOST_CWD=${CONDUCTOR_HOST_CWD:-/tmp}
    volumes:
    - ./config/conductor/config.yaml:/app/config.yaml:ro
    - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
    - 12199:8000
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
    extra_hosts:
    - primoia-mongodb:host-gateway
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
  community-conductor-bff:
    build:
      context: ./conductor/conductor-gateway
      dockerfile: Dockerfile
    container_name: community-conductor-bff
    restart: unless-stopped
    environment:
    - MONGODB_URL=${PRIMOIA_CONDUCTOR_MONGO_URI}
    - MONGODB_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
    - CONDUCTOR_API_URL=http://community-conductor-api:8000
    - IAM_ENABLED=true
    - IAM_SECRET_KEY=${PRIMOIA_IAM_SECRET_KEY}
    - IAM_URL=http://infrastructure-iam-api:8000
    - IAM_API_PREFIX=/api/v1
    volumes:
    - ./config/gateway/config.yaml:/app/config.yaml:ro
    ports:
    - 14199:8080
    depends_on:
    - community-conductor-api
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
  community-conductor-api-mcp:
    image: primoia/mcp-sidecar:latest
    build:
      context: ../shared/primoia-mcp-sidecar
      dockerfile: Dockerfile
    container_name: community-conductor-api-mcp
    restart: unless-stopped
    ports:
    - 13199:9000
    environment:
    - TARGET_URL=http://community-conductor-api:8000
    - MCP_PORT=9000
    - MCP_NAME=conductor-api-mcp
    - MCP_HOST_PORT=13199
    - ENABLE_IAM=true
    - IAM_URL=http://infrastructure-iam-api:8000
    - IAM_API_PREFIX=/api/v1
    - MCP_REGISTRY_ENABLED=${MCP_REGISTRY_ENABLED:-true}
    - MCP_REGISTRY_URL=${MCP_REGISTRY_URL:-http://community-conductor-bff:8080}
    - RATE_LIMIT_MAX_REQUESTS=300
    - RATE_LIMIT_WINDOW=60
    depends_on:
      community-conductor-api:
        condition: service_healthy
      community-conductor-bff:
        condition: service_healthy
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test:
      - CMD
      - python3
      - -c
      - import urllib.request; urllib.request.urlopen('http://localhost:9000/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  community-conductor-bff-mcp:
    image: primoia/mcp-sidecar:latest
    build:
      context: ../shared/primoia-mcp-sidecar
      dockerfile: Dockerfile
    container_name: community-conductor-bff-mcp
    restart: unless-stopped
    ports:
    - 15199:9000
    environment:
    - TARGET_URL=http://community-conductor-bff:8080
    - MCP_PORT=9000
    - MCP_NAME=conductor-bff-mcp
    - MCP_HOST_PORT=15199
    - ENABLE_IAM=true
    - IAM_URL=http://infrastructure-iam-api:8000
    - IAM_API_PREFIX=/api/v1
    - MCP_REGISTRY_ENABLED=${MCP_REGISTRY_ENABLED:-true}
    - MCP_REGISTRY_URL=${MCP_REGISTRY_URL:-http://community-conductor-bff:8080}
    - RATE_LIMIT_MAX_REQUESTS=300
    - RATE_LIMIT_WINDOW=60
    depends_on:
      community-conductor-bff:
        condition: service_healthy
    networks:
    - primoia-network
    - primoia-shared-infrastructure_primoia-infra-net
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test:
      - CMD
      - python3
      - -c
      - import urllib.request; urllib.request.urlopen('http://localhost:9000/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  community-conductor-web:
    build:
      context: ./conductor/conductor-web
      dockerfile: Dockerfile.angular
    container_name: community-conductor-web
    restart: unless-stopped
    volumes:
    - ./config/web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
    - 11299:80
    depends_on:
    - community-conductor-bff
    networks:
    - primoia-network

  # NOTE: conductor-chat (primobot-core + primobot-mcp) runs on host
  # Start with: cd conductor-chat/primobot-core && pnpm gateway:watch
  # See conductor-chat/README.md for details

networks:
  primoia-network:
    driver: bridge
  primoia-shared-infrastructure_primoia-infra-net:
    external: true
