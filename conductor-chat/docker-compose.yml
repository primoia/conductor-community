# Conductor Chat - Docker Compose
#
# NOTE: This file is for CONTAINER-BASED deployment.
# For development with primobot-core on HOST, use:
#   cd primobot-mcp && docker compose up -d
#
# Architecture:
#   primobot-core (HOST or container) → primobot-api (REST) → primobot-mcp (MCP tools)

services:
  # primobot-core - The main chat bot (fork of moltbot)
  # OPTIONAL: Only use if you want to run in container instead of host
  primobot-core:
    build:
      context: ./primobot-core
      dockerfile: Dockerfile
    container_name: primobot-core
    restart: unless-stopped
    profiles:
      - containerized  # Only starts with: docker compose --profile containerized up
    ports:
      - "${PRIMOBOT_CORE_PORT:-18789}:18789"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOME=/home/node
      - TERM=xterm-256color
    volumes:
      - primobot-config:/home/node/.clawdbot
      - primobot-workspace:/home/node/workspace
    networks:
      - conductor-chat-network
      - primoia-infra-net
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http = require('http'); http.get('http://localhost:18789/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # primobot-api - REST API adapter with OpenAPI
  primobot-api:
    build:
      context: ./primobot-mcp
      dockerfile: Dockerfile
    container_name: primobot-api
    restart: unless-stopped
    network_mode: host
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PRIMOBOT_CORE_URL=${PRIMOBOT_CORE_URL:-http://localhost:18789}
      - PRIMOBOT_MCP_PORT=3100
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GATEWAY_TOKEN=${GATEWAY_TOKEN:-}
      - GATEWAY_PASSWORD=${GATEWAY_PASSWORD:-}
    volumes:
      - ${HOME}/.openclaw:/root/.openclaw:ro
      - ./primobot-mcp/dist:/app/dist:ro
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http = require('http'); http.get('http://localhost:3100/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # primobot-mcp - MCP sidecar exposing tools
  primobot-mcp:
    build:
      context: ../../shared/primoia-mcp-sidecar
      dockerfile: Dockerfile
    container_name: primobot-mcp
    restart: unless-stopped
    ports:
      - "${PRIMOBOT_MCP_PORT:-13199}:9000"
    environment:
      - TARGET_URL=http://primobot-api:3100
      - MCP_PORT=9000
      - MCP_NAME=primobot
      - MCP_HOST_PORT=${PRIMOBOT_MCP_PORT:-13199}
      - ENABLE_IAM=${ENABLE_IAM:-false}
      - IAM_URL=${IAM_URL:-http://infrastructure-iam-api:8000}
      - IAM_API_PREFIX=/api/v1
      - MCP_REGISTRY_ENABLED=${MCP_REGISTRY_ENABLED:-false}
      - MCP_REGISTRY_URL=${MCP_REGISTRY_URL:-}
      - RATE_LIMIT_MAX_REQUESTS=300
      - RATE_LIMIT_WINDOW=60
    depends_on:
      primobot-api:
        condition: service_healthy
    networks:
      - conductor-chat-network
      - primoia-infra-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:9000/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  primobot-config:
  primobot-workspace:

networks:
  conductor-chat-network:
    driver: bridge
  primoia-infra-net:
    external: true
    name: primoia-shared-infrastructure_primoia-infra-net
