# Conductor Chat - Docker Compose
# Orchestrates primobot-core, primobot-mcp REST API, and MCP sidecar
version: '3.8'

services:
  # primobot-core - The main chat bot (fork of moltbot)
  # Gateway runs on port 18789
  primobot-core:
    build:
      context: ./primobot-core
      dockerfile: Dockerfile
    container_name: primobot-core
    restart: unless-stopped
    ports:
      - "${PRIMOBOT_CORE_PORT:-18789}:18789"
      - "${PRIMOBOT_BRIDGE_PORT:-18790}:18790"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOME=/home/node
      - TERM=xterm-256color
    volumes:
      - primobot-config:/home/node/.clawdbot
      - primobot-workspace:/home/node/workspace
    networks:
      - conductor-chat-network
      - primoia-infra-net
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # primobot-mcp - REST API adapter with OpenAPI
  primobot-mcp:
    build:
      context: ./primobot-mcp
      dockerfile: Dockerfile
    container_name: primobot-mcp
    restart: unless-stopped
    ports:
      - "${PRIMOBOT_MCP_PORT:-3100}:3100"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PRIMOBOT_CORE_URL=http://primobot-core:18789
      - PRIMOBOT_MCP_PORT=3100
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GATEWAY_TOKEN=${GATEWAY_TOKEN:-}
      - GATEWAY_PASSWORD=${GATEWAY_PASSWORD:-}
    depends_on:
      primobot-core:
        condition: service_healthy
    networks:
      - conductor-chat-network
      - primoia-infra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # primobot-mcp-sidecar - MCP protocol server (reads OpenAPI from primobot-mcp)
  primobot-mcp-sidecar:
    build:
      context: ../../shared/primoia-mcp-sidecar
      dockerfile: Dockerfile
    container_name: primobot-mcp-sidecar
    restart: unless-stopped
    ports:
      - "${MCP_SIDECAR_PORT:-3101}:9000"
    environment:
      - TARGET_URL=http://primobot-mcp:3100
      - MCP_PORT=9000
      - MCP_NAME=primobot-chat
      - MCP_HOST_PORT=${MCP_SIDECAR_PORT:-3101}
      - ENABLE_IAM=${ENABLE_IAM:-false}
      - IAM_URL=${IAM_URL:-http://infrastructure-iam-api:8000}
      - IAM_API_PREFIX=/api/v1
      - MCP_REGISTRY_ENABLED=${MCP_REGISTRY_ENABLED:-false}
      - MCP_REGISTRY_URL=${MCP_REGISTRY_URL:-}
      - RATE_LIMIT_MAX_REQUESTS=300
      - RATE_LIMIT_WINDOW=60
    depends_on:
      primobot-mcp:
        condition: service_healthy
    networks:
      - conductor-chat-network
      - primoia-infra-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  primobot-config:
  primobot-workspace:

networks:
  conductor-chat-network:
    driver: bridge
  primoia-infra-net:
    external: true
    name: primoia-shared-infrastructure_primoia-infra-net
