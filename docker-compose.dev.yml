# =============================================================
# AI: Arquitetura completa em ../AI_ARCHITECTURE.md
# MOTOR CENTRAL DE IA - roda UMA vez para todo o ecossistema
# Verticais consomem via API (nunca duplicar!)
# Portas: gateway:5006, web:8080, api:8000
# =============================================================
services:
  conductor-api:
    build:
      context: ./conductor/conductor
      dockerfile: Dockerfile
    container_name: conductor-api-dev
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - MONGO_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
      - MONGODB_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
      - IAM_ENABLED=true
      - IAM_SECRET_KEY=${PRIMOIA_IAM_SECRET_KEY}
      - IAM_URL=http://infrastructure-iam-api:8000
      - IAM_API_PREFIX=/api/v1
      - CONSTRUCTION_API_URL=http://verticals-construction-api-projects:8001
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./conductor/conductor:/app
      - ./config/conductor/config.yaml:/app/config.yaml:ro
    # SECURITY: Port removed - only accessible via private-net
    # ports:
    #   - "3000:8000"
    networks:
      - private-net  # Only accessible from gateway
      - primoia-shared-infrastructure_primoia-infra-net  # Access to shared MongoDB

  gateway:
    build:
      context: ./conductor/conductor-gateway
      dockerfile: Dockerfile
    container_name: conductor-gateway-dev
    restart: unless-stopped
    depends_on:
      - conductor-api
    environment:
      - NODE_ENV=development
      - MONGODB_URL=${PRIMOIA_CONDUCTOR_MONGO_URI}
      - MONGODB_URI=${PRIMOIA_CONDUCTOR_MONGO_URI}
      - CONDUCTOR_API_URL=http://community-conductor-api:8000
      - IAM_ENABLED=true
      - IAM_SECRET_KEY=${PRIMOIA_IAM_SECRET_KEY}
      - IAM_URL=http://infrastructure-iam-api:8000
      - IAM_API_PREFIX=/api/v1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./config/gateway/config.yaml:/app/config.yaml:ro
      - ./conductor/conductor-gateway/src:/app/src
    ports:
      - "5006:8080"
    networks:
      - public-net   # Public facing
      - private-net  # Access to conductor-api
      - primoia-shared-infrastructure_primoia-infra-net  # Access to shared MongoDB

  web:
    build:
      context: ./conductor/conductor-web
      dockerfile: Dockerfile.angular
    container_name: conductor-web-dev
    restart: unless-stopped
    depends_on:
      - gateway
    environment:
      - GATEWAY_URL=http://gateway:8080
    ports:
      - "8080:80"
    networks:
      - public-net  # Public facing

networks:
  # Public network - accessible from host and internet
  # Services: gateway, web, portfolio-web (future)
  public-net:
    driver: bridge

  # Private network - internal only, not exposed to host
  # Services: conductor-api
  # Only gateway has access to both networks
  private-net:
    driver: bridge
    internal: true  # Blocks external access

  # Shared infrastructure network - for MongoDB, Redis, etc
  primoia-shared-infrastructure_primoia-infra-net:
    external: true